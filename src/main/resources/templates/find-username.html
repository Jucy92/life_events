<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì´ë”” ì°¾ê¸° - ê²½ì¡°ê¸ˆ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .find-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            margin: 20px;
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo h1 {
            color: #667eea;
            font-weight: 700;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .result-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .username-display {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 15px;
        }
    </style>
</head>
<body>
    <div class="find-container">
        <div class="logo">
            <h1>ğŸ’° ê²½ì¡°ê¸ˆ ê´€ë¦¬</h1>
            <p class="text-muted">ì•„ì´ë”” ì°¾ê¸°</p>
        </div>

        <!-- Step 1: ì´ë©”ì¼ ì…ë ¥ ë° OTP ë°œì†¡ -->
        <div id="step1" class="step active">
            <form id="sendOtpForm">
                <div class="mb-3">
                    <label for="email" class="form-label">ì´ë©”ì¼</label>
                    <input type="email" class="form-control" id="email" name="email"
                           pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" required>
                    <small class="form-text text-muted">ê°€ì… ì‹œ ë“±ë¡í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>

                <button type="submit" class="btn btn-primary w-100">ì¸ì¦ë²ˆí˜¸ ë°œì†¡</button>
            </form>
        </div>

        <!-- Step 2: OTP ì¸ì¦ -->
        <div id="step2" class="step">
            <form id="verifyOtpForm">
                <div class="mb-3">
                    <label for="otpCode" class="form-label">ì¸ì¦ë²ˆí˜¸</label>
                    <input type="text" class="form-control" id="otpCode" name="otpCode"
                           maxlength="6" placeholder="6ìë¦¬ ì¸ì¦ë²ˆí˜¸ ì…ë ¥" required>
                    <small class="form-text text-muted">ì´ë©”ì¼ë¡œ ì „ì†¡ëœ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>

                <button type="submit" class="btn btn-primary w-100 mb-2">ì¸ì¦í•˜ê¸°</button>
                <button type="button" class="btn btn-outline-secondary w-100" id="resendOtpBtn">ì¬ë°œì†¡</button>
            </form>
        </div>

        <!-- Step 3: ì•„ì´ë”” í‘œì‹œ -->
        <div id="step3" class="step">
            <div class="result-box" id="resultBox">
                <p class="text-center text-muted mb-2">íšŒì›ë‹˜ì˜ ì•„ì´ë””ëŠ”</p>
                <div class="username-display" id="userIdDisplay"></div>
                <div class="text-center mt-3">
                    <a href="/login" class="btn btn-success">ë¡œê·¸ì¸í•˜ê¸°</a>
                    <a href="/find-password" class="btn btn-outline-primary" id="goToPasswordReset">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
                </div>
            </div>
        </div>

        <div class="text-center mt-3">
            <p><a href="/find-password">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a> | <a href="/register">íšŒì›ê°€ì…</a></p>
            <p><a href="/login">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a></p>
        </div>
    </div>

    <script>
        let userEmail = '';
        let resendCooldownTimer = null;

        // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ íƒ€ì´ë¨¸ ì‹œì‘
        function startResendCooldown() {
            const resendBtn = document.getElementById('resendOtpBtn');
            let countdown = 30;

            resendBtn.disabled = true;
            resendBtn.textContent = `ì¬ë°œì†¡ (${countdown}ì´ˆ)`;

            resendCooldownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    resendBtn.textContent = `ì¬ë°œì†¡ (${countdown}ì´ˆ)`;
                } else {
                    clearInterval(resendCooldownTimer);
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'ì¬ë°œì†¡';
                }
            }, 1000);
        }

        // OTP ë°œì†¡ í•¨ìˆ˜ (ì¬ì‚¬ìš© ê°€ëŠ¥)
        async function sendOtp(email) {
            const response = await fetch('/api/auth/send-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                body: JSON.stringify({ email })
            });
            return response;
        }

        // Step 1: ì¸ì¦ë²ˆí˜¸ ë°œì†¡
        document.getElementById('sendOtpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;

            // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailPattern.test(email)) {
                alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'ë°œì†¡ ì¤‘...';

            try {
                const response = await sendOtp(email);
                const data = await response.json();

                if (response.ok) {
                    userEmail = email;
                    alert(data.message);
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');

                    // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ ì‹œì‘
                    startResendCooldown();
                } else {
                    alert(data.error || 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                console.error(error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });

        // ì¬ë°œì†¡ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        document.getElementById('resendOtpBtn').addEventListener('click', async () => {
            if (!userEmail) {
                alert('ì´ë©”ì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const resendBtn = document.getElementById('resendOtpBtn');
            const originalText = resendBtn.textContent;
            resendBtn.disabled = true;
            resendBtn.textContent = 'ë°œì†¡ ì¤‘...';

            try {
                const response = await sendOtp(userEmail);
                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ ë‹¤ì‹œ ì‹œì‘
                    startResendCooldown();
                } else {
                    alert(data.error || 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    resendBtn.disabled = false;
                    resendBtn.textContent = originalText;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                console.error(error);
                resendBtn.disabled = false;
                resendBtn.textContent = originalText;
            }
        });

        // Step 2: OTP ì¸ì¦
        document.getElementById('verifyOtpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const otpCode = document.getElementById('otpCode').value;
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'í™•ì¸ ì¤‘...';

            try {
                const response = await fetch('/api/auth/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                    body: JSON.stringify({ email: userEmail, otpCode })
                });

                const data = await response.json();

                if (response.ok && data.verified) {
                    // ì•„ì´ë”” ì¡°íšŒ
                    const findResponse = await fetch('/api/auth/find-userid', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                        body: JSON.stringify({ email: userEmail })
                    });

                    const findData = await findResponse.json();

                    if (findResponse.ok) {
                        // sessionStorage ì‚¬ìš© ì´ìœ : ì•„ì´ë”” ì°¾ê¸° â†’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ UX ê°œì„ 
                        // - íƒ­ ë‹«ìœ¼ë©´ ìë™ ì‚­ì œ (ë³´ì•ˆ)
                        // - 10ë¶„ ë‚´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í˜ì´ì§€ ì´ë™ ì‹œ ì¸ì¦ ìŠ¤í‚µ
                        // - localStorageì™€ ë‹¬ë¦¬ ì˜êµ¬ ì €ì¥ ì•ˆ ë¨
                        sessionStorage.setItem('verifiedEmail', userEmail);
                        sessionStorage.setItem('verifiedUserId', findData.userId);
                        sessionStorage.setItem('emailVerifiedAt', new Date().getTime().toString());

                        document.getElementById('userIdDisplay').textContent = findData.userId;

                        // Step 2 ìˆ¨ê¸°ê³  Step 3 í‘œì‹œ
                        document.getElementById('step2').classList.remove('active');
                        document.getElementById('step3').classList.add('active');

                        // ì¬ë°œì†¡ íƒ€ì´ë¨¸ ì •ë¦¬ (ì¸ì¦ ì™„ë£Œë˜ì–´ ë” ì´ìƒ í•„ìš” ì—†ìŒ)
                        if (resendCooldownTimer) {
                            clearInterval(resendCooldownTimer);
                            resendCooldownTimer = null;
                        }

                        // ê²°ê³¼ ë°•ìŠ¤ í‘œì‹œ (ì•„ì´ë”” í‘œì‹œ)
                        document.getElementById('resultBox').style.display = 'block';
                    } else {
                        alert(findData.error || 'ì•„ì´ë””ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                    }
                } else {
                    alert(data.error || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                console.error(error);
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì¸ì¦ ì •ë³´ ìœ ì§€
        document.getElementById('goToPasswordReset').addEventListener('click', (e) => {
            // sessionStorageì— ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ê·¸ëƒ¥ ì´ë™
            // ë§í¬ì˜ ê¸°ë³¸ ë™ì‘(href)ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        });
    </script>
</body>
</html>
