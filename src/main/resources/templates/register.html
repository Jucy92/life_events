<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì›ê°€ì… - ê²½ì¡°ê¸ˆ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .register-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            margin: 20px;
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo h1 {
            color: #667eea;
            font-weight: 700;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="register-container">
        <div class="logo">
            <h1>ğŸ’° ê²½ì¡°ê¸ˆ ê´€ë¦¬</h1>
            <p class="text-muted">ê³„ì •ì„ ë§Œë“¤ì–´ ì‹œì‘í•˜ì„¸ìš”</p>
        </div>

        <form id="registerForm">
            <div class="mb-3">
                <label for="userId" class="form-label">ì•„ì´ë””</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="userId" name="userId"
                           minlength="4" maxlength="50" pattern="[a-zA-Z0-9]+" required>
                    <button type="button" class="btn btn-outline-secondary" id="checkUserIdBtn">
                        ì¤‘ë³µí™•ì¸
                    </button>
                </div>
                <small class="form-text text-muted">4~50ìì˜ ì˜ë¬¸, ìˆ«ì ì¡°í•© (íŠ¹ìˆ˜ë¬¸ì ë¶ˆê°€)</small>
                <small class="form-text text-success" id="userIdSuccessMsg" style="display: none;">
                    âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤
                </small>
                <small class="form-text text-danger" id="userIdErrorMsg" style="display: none;">
                    âœ— ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤
                </small>
            </div>

            <div class="mb-3">
                <label for="name" class="form-label">ì´ë¦„</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">ì´ë©”ì¼</label>
                <div class="input-group">
                    <input type="email" class="form-control" id="email" name="email"
                           pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" required>
                    <button type="button" class="btn btn-outline-primary" id="sendOtpBtn">
                        ì¸ì¦ë²ˆí˜¸ ë°œì†¡
                    </button>
                </div>
                <small class="form-text text-muted">ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: example@domain.com)</small>
            </div>

            <div class="mb-3" id="otpSection" style="display: none;">
                <label for="otpCode" class="form-label">ì¸ì¦ë²ˆí˜¸</label>
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="otpCode" name="otpCode"
                           maxlength="6" placeholder="6ìë¦¬ ì¸ì¦ë²ˆí˜¸ ì…ë ¥">
                    <button type="button" class="btn btn-success" id="verifyOtpBtn">
                        ì¸ì¦í•˜ê¸°
                    </button>
                </div>
                <button type="button" class="btn btn-outline-secondary w-100 mb-2" id="resendOtpBtn" style="display: none;">
                    ì¬ë°œì†¡
                </button>
                <small class="form-text text-muted">ì´ë©”ì¼ë¡œ ì „ì†¡ëœ 6ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                <small class="form-text text-success" id="otpSuccessMsg" style="display: none;">
                    âœ“ ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
                </small>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-control" id="password" name="password"
                       minlength="8" required>
                <small class="form-text text-muted">ìµœì†Œ 8ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”</small>
            </div>

            <div class="mb-3">
                <label for="confirmPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" class="form-control" id="confirmPassword"
                       name="confirmPassword" required>
            </div>

            <button type="submit" class="btn btn-primary w-100">íšŒì›ê°€ì…</button>
        </form>

        <div class="text-center mt-3">
            <p>ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login">ë¡œê·¸ì¸</a></p>
            <p><a href="/find-username">ì•„ì´ë”” ì°¾ê¸°</a> | <a href="/find-password">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a></p>
        </div>
    </div>

    <script>
        let isSubmitting = false;
        let emailVerified = false;
        let verifiedEmail = '';
        let userIdChecked = false;
        let checkedUserId = '';
        let resendCooldownTimer = null;

        // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ íƒ€ì´ë¨¸ ì‹œì‘
        function startResendCooldown() {
            const resendBtn = document.getElementById('resendOtpBtn');
            let countdown = 30;

            resendBtn.style.display = 'block';
            resendBtn.disabled = true;
            resendBtn.textContent = `ì¬ë°œì†¡ (${countdown}ì´ˆ)`;

            resendCooldownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    resendBtn.textContent = `ì¬ë°œì†¡ (${countdown}ì´ˆ)`;
                } else {
                    clearInterval(resendCooldownTimer);
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'ì¬ë°œì†¡';
                }
            }, 1000);
        }

        // OTP ë°œì†¡ í•¨ìˆ˜ (ì¬ì‚¬ìš© ê°€ëŠ¥)
        async function sendOtp(email) {
            const response = await fetch('/api/auth/send-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            return response;
        }

        // ì•„ì´ë”” ì¤‘ë³µí™•ì¸ ë²„íŠ¼
        document.getElementById('checkUserIdBtn').addEventListener('click', async () => {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì•„ì´ë”” í˜•ì‹ ê²€ì¦
            const userIdPattern = /^[a-zA-Z0-9]{4,50}$/;
            if (!userIdPattern.test(userId)) {
                alert('ì•„ì´ë””ëŠ” 4~50ìì˜ ì˜ë¬¸, ìˆ«ì ì¡°í•©ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const checkBtn = document.getElementById('checkUserIdBtn');
            checkBtn.disabled = true;
            checkBtn.textContent = 'í™•ì¸ ì¤‘...';

            try {
                const response = await fetch(`/api/auth/check-userid?userId=${encodeURIComponent(userId)}`);
                const data = await response.json();

                document.getElementById('userIdSuccessMsg').style.display = 'none';
                document.getElementById('userIdErrorMsg').style.display = 'none';

                if (data.available) {
                    userIdChecked = true;
                    checkedUserId = userId;
                    document.getElementById('userIdSuccessMsg').style.display = 'block';
                    checkBtn.textContent = 'í™•ì¸ì™„ë£Œ';
                    checkBtn.classList.remove('btn-outline-secondary');
                    checkBtn.classList.add('btn-success');
                } else {
                    userIdChecked = false;
                    document.getElementById('userIdErrorMsg').style.display = 'block';
                    checkBtn.textContent = 'ì¤‘ë³µí™•ì¸';
                    checkBtn.disabled = false;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
                checkBtn.textContent = 'ì¤‘ë³µí™•ì¸';
                checkBtn.disabled = false;
            }
        });

        // ì•„ì´ë”” ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì¤‘ë³µí™•ì¸ ì´ˆê¸°í™”
        document.getElementById('userId').addEventListener('input', () => {
            const userId = document.getElementById('userId').value;
            if (userId !== checkedUserId) {
                userIdChecked = false;
                const checkBtn = document.getElementById('checkUserIdBtn');
                checkBtn.disabled = false;
                checkBtn.textContent = 'ì¤‘ë³µí™•ì¸';
                checkBtn.classList.remove('btn-success');
                checkBtn.classList.add('btn-outline-secondary');
                document.getElementById('userIdSuccessMsg').style.display = 'none';
                document.getElementById('userIdErrorMsg').style.display = 'none';
            }
        });

        // ì´ë©”ì¼ ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì¸ì¦ ìƒíƒœ ì´ˆê¸°í™”
        document.getElementById('email').addEventListener('input', () => {
            const email = document.getElementById('email').value;
            if (email !== verifiedEmail) {
                emailVerified = false;
                document.getElementById('otpSuccessMsg').style.display = 'none';
                document.getElementById('otpSection').style.display = 'none';
                document.getElementById('otpCode').value = '';
                document.getElementById('otpCode').disabled = false;
                const verifyBtn = document.getElementById('verifyOtpBtn');
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'ì¸ì¦í•˜ê¸°';
                verifyBtn.classList.remove('btn-secondary');
                verifyBtn.classList.add('btn-success');

                // ì¬ë°œì†¡ ë²„íŠ¼ ìˆ¨ê¸°ê¸° ë° íƒ€ì´ë¨¸ ì •ë¦¬
                const resendBtn = document.getElementById('resendOtpBtn');
                resendBtn.style.display = 'none';
                if (resendCooldownTimer) {
                    clearInterval(resendCooldownTimer);
                    resendCooldownTimer = null;
                }

                // ë°œì†¡ ë²„íŠ¼ ì›ë˜ëŒ€ë¡œ
                const sendBtn = document.getElementById('sendOtpBtn');
                sendBtn.textContent = 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡';
                sendBtn.disabled = false;
                sendBtn.classList.remove('btn-success');
                sendBtn.classList.add('btn-outline-primary');
            }
        });

        // OTP ë°œì†¡ ë²„íŠ¼
        document.getElementById('sendOtpBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            if (!email) {
                alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailPattern.test(email)) {
                alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const sendBtn = document.getElementById('sendOtpBtn');
            const originalText = sendBtn.textContent;
            sendBtn.disabled = true;
            sendBtn.textContent = 'ë°œì†¡ ì¤‘...';

            try {
                const response = await sendOtp(email);
                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    document.getElementById('otpSection').style.display = 'block';
                    sendBtn.textContent = 'ì¬ë°œì†¡';

                    // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ ì‹œì‘
                    startResendCooldown();
                } else {
                    alert(data.error || 'ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    sendBtn.textContent = originalText;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
                sendBtn.textContent = originalText;
            } finally {
                sendBtn.disabled = false;
            }
        });

        // ì¬ë°œì†¡ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        document.getElementById('resendOtpBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            if (!email) {
                alert('ì´ë©”ì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const resendBtn = document.getElementById('resendOtpBtn');
            const originalText = resendBtn.textContent;
            resendBtn.disabled = true;
            resendBtn.textContent = 'ë°œì†¡ ì¤‘...';

            try {
                const response = await sendOtp(email);
                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ ë‹¤ì‹œ ì‹œì‘
                    startResendCooldown();
                } else {
                    alert(data.error || 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    resendBtn.disabled = false;
                    resendBtn.textContent = originalText;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
                resendBtn.disabled = false;
                resendBtn.textContent = originalText;
            }
        });

        // OTP ì¸ì¦ ë²„íŠ¼
        document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const otpCode = document.getElementById('otpCode').value;

            if (!otpCode) {
                alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const verifyBtn = document.getElementById('verifyOtpBtn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'í™•ì¸ ì¤‘...';

            try {
                const response = await fetch('/api/auth/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otpCode })
                });

                const data = await response.json();

                if (response.ok && data.verified) {
                    emailVerified = true;
                    verifiedEmail = email;
                    alert(data.message);

                    // OTP ì„¹ì…˜ ì „ì²´ ìˆ¨ê¹€
                    document.getElementById('otpSection').style.display = 'none';

                    // ì¬ë°œì†¡ íƒ€ì´ë¨¸ ì •ë¦¬
                    if (resendCooldownTimer) {
                        clearInterval(resendCooldownTimer);
                        resendCooldownTimer = null;
                    }

                    // ì´ë©”ì¼ í•„ë“œ ì˜† ë°œì†¡ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                    const sendBtn = document.getElementById('sendOtpBtn');
                    sendBtn.textContent = 'ì¸ì¦ ì™„ë£Œ âœ“';
                    sendBtn.disabled = true;
                    sendBtn.classList.remove('btn-outline-primary');
                    sendBtn.classList.add('btn-success');
                } else {
                    alert(data.error || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    verifyBtn.textContent = 'ì¸ì¦í•˜ê¸°';
                    verifyBtn.disabled = false;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
                verifyBtn.textContent = 'ì¸ì¦í•˜ê¸°';
                verifyBtn.disabled = false;
            }
        });

        // íšŒì›ê°€ì… í¼ ì œì¶œ
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (isSubmitting) return;

            if (!userIdChecked) {
                alert('ì•„ì´ë”” ì¤‘ë³µí™•ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!emailVerified) {
                alert('ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const userId = document.getElementById('userId').value;
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (email !== verifiedEmail) {
                alert('ì¸ì¦ëœ ì´ë©”ì¼ê³¼ í˜„ì¬ ì´ë©”ì¼ì´ ë‹¤ë¦…ë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì„¸ìš”.');
                emailVerified = false;
                return;
            }

            if (password !== confirmPassword) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            isSubmitting = true;
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'ì²˜ë¦¬ ì¤‘...';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        name,
                        email,
                        password,
                        emailVerified: true
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // JWT í† í°ê³¼ ì‚¬ìš©ì ì •ë³´ ì €ì¥
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í™˜ì˜í•©ë‹ˆë‹¤!');
                    window.location.href = '/dashboard';
                } else {
                    const contentType = response.headers.get('content-type');
                    let errorMessage = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';

                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        if (error.message) {
                            errorMessage = error.message;
                        }
                    }

                    alert(errorMessage);
                    isSubmitting = false;
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                console.error(error);
                isSubmitting = false;
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });
    </script>
</body>
</html>
