<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드 - 경조금 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-card .card-body {
            padding: 25px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
        }
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .badge-amount {
            background: #28a745;
            padding: 5px 10px;
            border-radius: 5px;
        }
        /* 메모 영역 스타일 개선 */
        .table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .table td:nth-child(8) { /* 메모 칸 */
            max-width: 250px;
            min-width: 150px;
            overflow-y: auto;
            white-space: normal;
            word-wrap: break-word;
            max-height: 80px; /* 3줄*/
            display: block;
        }
        /* 커스텀 날짜 입력 스타일 */
        .custom-date-input {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.1em;
        }
        .date-input-group {
            display: flex;
            gap: 8px;
        }
        .date-input-group input[type="text"] {
            flex: 1;
        }
        .date-input-group button {
            width: 40px;
            padding: 0;
        }
        /* Toast 메시지 스타일 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            min-width: 250px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .toast.success { border-left: 4px solid #28a745; }
        .toast.error { border-left: 4px solid #dc3545; }
        .toast.warning { border-left: 4px solid #ffc107; }
        .toast.info { border-left: 4px solid #17a2b8; }
        .toast-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        .toast-message {
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-gift"></i> 경조금 관리 시스템
            </span>
            <div>
                <span class="text-white me-3" id="userName"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 로그아웃
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 통계 카드 -->
        <div class="row">
            <!-- 받은 경조금 통계 -->
            <div class="col-md-4">
                <div class="card stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="card-body text-center">
                        <i class="fas fa-arrow-down fa-2x mb-2"></i>
                        <h6 class="mb-3">받은 경조금</h6>
                        <div class="stat-value" id="receivedAmount">0원</div>
                        <p class="mb-0"><span id="receivedCount">0</span>건</p>
                    </div>
                </div>
            </div>
            <!-- 보낸 경조금 통계 -->
            <div class="col-md-4">
                <div class="card stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                    <div class="card-body text-center">
                        <i class="fas fa-arrow-up fa-2x mb-2"></i>
                        <h6 class="mb-3">보낸 경조금</h6>
                        <div class="stat-value" id="sentAmount">0원</div>
                        <p class="mb-0"><span id="sentCount">0</span>건</p>
                    </div>
                </div>
            </div>
            <!-- 차액 (받은 - 보낸) -->
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-balance-scale fa-2x mb-2"></i>
                        <h6 class="mb-3">차액 (받은 - 보낸)</h6>
                        <div class="stat-value" id="differenceAmount">0원</div>
                        <p class="mb-0">전체 <span id="totalCount">0</span>건</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 경조금 목록 -->
        <div class="table-container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-list"></i> 경조금 목록</h4>
                <div>
                    <button class="btn btn-add me-2" onclick="showUploadModal()">
                        <i class="fas fa-upload"></i> Excel 업로드
                    </button>
                    <button class="btn btn-add" onclick="showAddModal()">
                        <i class="fas fa-plus"></i> 추가하기
                    </button>
                </div>
            </div>

            <!-- 탭 메뉴 -->
            <ul class="nav nav-tabs mb-3" id="transactionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="received-tab" data-bs-toggle="tab"
                            data-bs-target="#received" type="button" role="tab"
                            onclick="filterByType('RECEIVED')">
                        <i class="fas fa-arrow-down text-success"></i> 받은 경조금
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sent-tab" data-bs-toggle="tab"
                            data-bs-target="#sent" type="button" role="tab"
                            onclick="filterByType('SENT')">
                        <i class="fas fa-arrow-up text-primary"></i> 보낸 경조금
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-tab" data-bs-toggle="tab"
                            data-bs-target="#all" type="button" role="tab"
                            onclick="filterByType('')">
                        <i class="fas fa-list"></i> 전체
                    </button>
                </li>
            </ul>

            <!-- 검색 -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput"
                               placeholder="보낸 사람 이름으로 검색... (입력하면 자동 검색됩니다)">
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>구분</th>
                            <th>행사 날짜</th>
                            <th>행사 유형</th>
                            <th>보낸 사람</th>
                            <th>관계</th>
                            <th>금액</th>
                            <th>연락처</th>
                            <th>메모</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="giftMoneyTable">
                        <tr>
                            <td colspan="9" class="text-center">데이터를 불러오는 중...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 페이지네이션 -->
            <nav>
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>

    <!-- 추가/수정 모달 -->
    <div class="modal fade" id="giftMoneyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">경조금 추가</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="giftMoneyForm">
                        <input type="hidden" id="giftMoneyId">
                        <div class="mb-3">
                            <label for="eventDate" class="form-label">행사 날짜 <span class="text-danger">(*필수)</span></label>
                            <div class="date-input-group">
                                <input type="text" class="form-control custom-date-input" id="eventDate"
                                       placeholder="yyyy.mm.dd" maxlength="10" required>
                                <button type="button" class="btn btn-outline-secondary" id="calendarBtn"
                                        title="달력 열기">
                                    <i class="fas fa-calendar-alt"></i>
                                </button>
                            </div>
                            <input type="hidden" id="eventDateValue">
                            <input type="date" id="calendarPicker" style="position: absolute; opacity: 0; pointer-events: none;">
                            <div class="text-danger small mt-1" id="eventDateWarning" style="display: none;">
                                ⚠️ 미래의 날짜를 선택했습니다
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="eventType" class="form-label">행사 유형 <span class="text-danger">(*필수)</span></label>
                            <select class="form-select" id="eventType" required>
                                <option value="">선택하세요</option>
                                <option value="결혼식">결혼식</option>
                                <option value="장례식">장례식</option>
                                <option value="돌잔치">돌잔치</option>
                                <option value="개업">개업</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="transactionType" class="form-label">거래 유형 <span class="text-danger">(*필수)</span></label>
                            <select class="form-select" id="transactionType" required>
                                <option value="RECEIVED">받은 경조금</option>
                                <option value="SENT">보낸 경조금</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="giverName" class="form-label">보낸 사람 <span class="text-danger">(*필수)</span></label>
                            <input type="text" class="form-control" id="giverName" required>
                        </div>
                        <div class="mb-3">
                            <label for="giverRelation" class="form-label">관계</label>
                            <input type="text" class="form-control" id="giverRelation"
                                   placeholder="예: 친구, 가족, 직장동료">
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">금액 <span class="text-danger">(*필수)</span></label>
                            <input type="text" class="form-control" id="amount" required placeholder="예: 100,000">
                            <input type="hidden" id="amountValue">
                        </div>
                        <div class="mb-3">
                            <label for="contact" class="form-label">연락처</label>
                            <input type="text" class="form-control" id="contact"
                                   placeholder="010-1234-5678">
                        </div>
                        <div class="mb-3">
                            <label for="memo" class="form-label">메모</label>
                            <textarea class="form-control" id="memo" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveGiftMoney()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel 업로드 모달 -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Excel 파일 업로드</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Excel 파일 선택</label>
                        <input type="file" class="form-control" id="fileInput" accept=".xlsx,.xls">
                        <small class="form-text text-muted">
                            형식: event_date, event_type, giver_name, giver_relation, amount, contact, memo
                        </small>
                    </div>
                    <div class="alert alert-info">
                        <strong>템플릿 다운로드:</strong>
                        <a href="/api/template/download" download>여기를 클릭</a>하여
                        예시 파일을 다운로드하세요.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="uploadFile()">업로드</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/dashboard.js"></script>
</body>
</html>
