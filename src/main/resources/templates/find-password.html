<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° - ê²½ì¡°ê¸ˆ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .find-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            margin: 20px;
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo h1 {
            color: #667eea;
            font-weight: 700;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="find-container">
        <div class="logo">
            <h1>ğŸ’° ê²½ì¡°ê¸ˆ ê´€ë¦¬</h1>
            <p class="text-muted">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</p>
        </div>

        <!-- Step 1: ì•„ì´ë””/ì´ë©”ì¼ ì…ë ¥ -->
        <div id="step1" class="step active">
            <form id="requestOtpForm">
                <div class="mb-3">
                    <label for="userId" class="form-label">ì•„ì´ë””</label>
                    <input type="text" class="form-control" id="userId" name="userId"
                           minlength="4" maxlength="50" pattern="[a-zA-Z0-9]+" required>
                    <small class="form-text text-muted">4~50ìì˜ ì˜ë¬¸, ìˆ«ì ì¡°í•©</small>
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">ì´ë©”ì¼</label>
                    <input type="email" class="form-control" id="email" name="email"
                           pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" required>
                    <small class="form-text text-muted">ê°€ì… ì‹œ ë“±ë¡í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>

                <button type="submit" class="btn btn-primary w-100">ì¸ì¦ë²ˆí˜¸ ë°œì†¡</button>
            </form>
        </div>

        <!-- Step 2: OTP ì¸ì¦ -->
        <div id="step2" class="step">
            <form id="verifyOtpForm">
                <div class="mb-3">
                    <label for="otpCode" class="form-label">ì¸ì¦ë²ˆí˜¸</label>
                    <input type="text" class="form-control" id="otpCode" name="otpCode"
                           maxlength="6" placeholder="6ìë¦¬ ì¸ì¦ë²ˆí˜¸ ì…ë ¥" required>
                    <small class="form-text text-muted">ì´ë©”ì¼ë¡œ ì „ì†¡ëœ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>

                <button type="submit" class="btn btn-primary w-100 mb-2">ì¸ì¦í•˜ê¸°</button>
                <button type="button" class="btn btn-outline-secondary w-100" id="resendOtpBtn">ì¬ë°œì†¡</button>
            </form>
        </div>

        <!-- Step 3: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • -->
        <div id="step3" class="step">
            <form id="resetPasswordForm">
                <div class="mb-3">
                    <label for="newPassword" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" class="form-control" id="newPassword" name="newPassword"
                           minlength="8" required>
                    <small class="form-text text-muted">ìµœì†Œ 8ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>

                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" class="form-control" id="confirmPassword"
                           name="confirmPassword" required>
                </div>

                <button type="submit" class="btn btn-primary w-100">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
            </form>
        </div>

        <div class="text-center mt-3">
            <p><a href="/find-username">ì•„ì´ë”” ì°¾ê¸°</a> | <a href="/register">íšŒì›ê°€ì…</a></p>
            <p><a href="/login">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a></p>
        </div>
    </div>

    <script>
        let userEmail = '';
        let verifiedOtpCode = '';
        let preVerifiedUserId = '';
        let resendCooldownTimer = null;

        // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ íƒ€ì´ë¨¸ ì‹œì‘
        function startResendCooldown() {
            const resendBtn = document.getElementById('resendOtpBtn');
            let countdown = 30;

            resendBtn.disabled = true;
            resendBtn.textContent = `ì¬ë°œì†¡ (${countdown}ì´ˆ)`;

            resendCooldownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    resendBtn.textContent = `ì¬ë°œì†¡ (${countdown}ì´ˆ)`;
                } else {
                    clearInterval(resendCooldownTimer);
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'ì¬ë°œì†¡';
                }
            }, 1000);
        }

        // OTP ë°œì†¡ í•¨ìˆ˜ (ì¬ì‚¬ìš© ê°€ëŠ¥)
        async function sendPasswordResetOtp(userId, email) {
            const response = await fetch('/api/auth/reset-password-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                body: JSON.stringify({ userId, email })
            });
            return response;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•„ì´ë”” ì°¾ê¸°ì—ì„œ ì¸ì¦í•œ ì •ë³´ í™•ì¸
        // sessionStorage: ì•„ì´ë”” ì°¾ê¸° â†’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì—°ê²°ìš© ì„ì‹œ ì €ì¥ì†Œ
        // (íƒ­ ë‹«ìœ¼ë©´ ìë™ ì‚­ì œ, localStorageì™€ ë‹¤ë¦„)
        window.addEventListener('DOMContentLoaded', () => {
            const verifiedEmail = sessionStorage.getItem('verifiedEmail');
            const verifiedUserId = sessionStorage.getItem('verifiedUserId');
            const verifiedAt = sessionStorage.getItem('emailVerifiedAt');

            // ì¸ì¦ ì •ë³´ê°€ ìˆê³  10ë¶„ ì´ë‚´ì¸ì§€ í™•ì¸
            if (verifiedEmail && verifiedUserId && verifiedAt) {
                const now = new Date().getTime();
                const verifiedTime = parseInt(verifiedAt);
                const tenMinutes = 10 * 60 * 1000;

                // ê²€ì¦: ì‹œê°„ì´ ë¯¸ë˜ê°€ ì•„ë‹ˆê³ , 10ë¶„ ì´ë‚´ì¸ì§€ í™•ì¸
                if (verifiedTime <= now && (now - verifiedTime) < tenMinutes) {
                    // ì´ë¯¸ ì¸ì¦ëœ ê²½ìš° ë°”ë¡œ Step 3ìœ¼ë¡œ
                    userEmail = verifiedEmail;
                    preVerifiedUserId = verifiedUserId;
                    // âš ï¸ ë³´ì•ˆ: ë°±ë„ì–´ OTP ì œê±°ë¨ - ì•„ì´ë”” ì°¾ê¸°ì—ì„œ ê²€ì¦ëœ ì‚¬ìš©ìëŠ” OTP ì¬ê²€ì¦ ì—†ì´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥
                    verifiedOtpCode = 'VERIFIED_FROM_FIND_USERNAME'; // ì•„ì´ë”” ì°¾ê¸°ì—ì„œ ì´ë¯¸ ì¸ì¦ ì™„ë£Œ

                    // Step 1, 2 ìˆ¨ê¸°ê³  Step 3ë§Œ í‘œì‹œ (ì¸ì¦ ìŠ¤í‚µ)
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step3').classList.add('active');

                    // sessionStorage í´ë¦¬ì–´: ì¼íšŒì„± ì‚¬ìš© í›„ ì¦‰ì‹œ ì‚­ì œ
                    // (ì•„ì´ë”” ì°¾ê¸° â†’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì—°ê²° ì™„ë£Œ)
                    sessionStorage.removeItem('verifiedEmail');
                    sessionStorage.removeItem('verifiedUserId');
                    sessionStorage.removeItem('emailVerifiedAt');

                    alert('ì•„ì´ë”” ì°¾ê¸°ì—ì„œ ì´ë¯¸ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.\nì•„ì´ë””: ' + verifiedUserId + '\në°”ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •í•˜ì„¸ìš”.');
                } else {
                    // ì¸ì¦ ë§Œë£Œ ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ â†’ ì„ì‹œ ì €ì¥ì†Œ ì •ë¦¬
                    // (10ë¶„ ì´ˆê³¼, ë˜ëŠ” ì‹œê°„ ì¡°ì‘ ì‹œë„)
                    sessionStorage.removeItem('verifiedEmail');
                    sessionStorage.removeItem('verifiedUserId');
                    sessionStorage.removeItem('emailVerifiedAt');

                    console.log('ì¸ì¦ ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            }
        });

        // Step 1: ì¸ì¦ë²ˆí˜¸ ìš”ì²­
        document.getElementById('requestOtpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = document.getElementById('userId').value;
            const email = document.getElementById('email').value;

            // ì•„ì´ë”” í˜•ì‹ ê²€ì¦
            const userIdPattern = /^[a-zA-Z0-9]{4,50}$/;
            if (!userIdPattern.test(userId)) {
                alert('ì•„ì´ë””ëŠ” 4~50ìì˜ ì˜ë¬¸, ìˆ«ì ì¡°í•©ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailPattern.test(email)) {
                alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'ë°œì†¡ ì¤‘...';

            try {
                const response = await sendPasswordResetOtp(userId, email);
                const data = await response.json();

                if (response.ok) {
                    userEmail = email;
                    preVerifiedUserId = userId;
                    alert(data.message);
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');

                    // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ ì‹œì‘
                    startResendCooldown();
                } else {
                    alert(data.error || 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                console.error(error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });

        // ì¬ë°œì†¡ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        document.getElementById('resendOtpBtn').addEventListener('click', async () => {
            if (!userEmail || !preVerifiedUserId) {
                alert('ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const resendBtn = document.getElementById('resendOtpBtn');
            const originalText = resendBtn.textContent;
            resendBtn.disabled = true;
            resendBtn.textContent = 'ë°œì†¡ ì¤‘...';

            try {
                const response = await sendPasswordResetOtp(preVerifiedUserId, userEmail);
                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    // ì¬ë°œì†¡ ì¿¨ë‹¤ìš´ ë‹¤ì‹œ ì‹œì‘
                    startResendCooldown();
                } else {
                    alert(data.error || 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    resendBtn.disabled = false;
                    resendBtn.textContent = originalText;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                console.error(error);
                resendBtn.disabled = false;
                resendBtn.textContent = originalText;
            }
        });

        // Step 2: OTP ì¸ì¦
        document.getElementById('verifyOtpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const otpCode = document.getElementById('otpCode').value;
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'í™•ì¸ ì¤‘...';

            try {
                const response = await fetch('/api/auth/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                    body: JSON.stringify({ email: userEmail, otpCode })
                });

                const data = await response.json();

                if (response.ok && data.verified) {
                    verifiedOtpCode = otpCode;
                    alert(data.message);
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step3').classList.add('active');
                } else {
                    alert(data.error || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                console.error(error);
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });

        // Step 3: ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'ì²˜ë¦¬ ì¤‘...';

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                    body: JSON.stringify({
                        email: userEmail,
                        otpCode: verifiedOtpCode,
                        newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message + ' ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                } else {
                    alert(data.error || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                console.error(error);
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });
    </script>
</body>
</html>
